<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKR Quantum Tracker | LIVE</title>
    <"https://mob-connect-default-rtdb.firebaseio.com" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --primary: #3b82f6; --success: #10b981; --danger: #f43f5e; 
            --dark: #0f172a; --bg: #f8fafc; --accent: #fbbf24;
            --glass: rgba(255, 255, 255, 0.8);
        }

        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background: var(--bg); color: var(--dark); margin: 0; 
            overflow-x: hidden;
        }

        /* YOUR ORIGINAL ANIMATIONS */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .reveal { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .header { 
            position: sticky; top: 0; background: var(--glass); z-index: 1000;
            backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 12px 0;
        }

        .header-wrap {
            max-width: 1000px; margin: auto; padding: 0 20px;
            display: flex; align-items: center; gap: 15px;
        }

        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; flex-grow: 1; }
        
        /* QR BOX ON RIGHT */
        .qr-card {
            background: white; padding: 8px; border-radius: 18px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee;
            text-align: center; min-width: 85px;
        }
        .qr-card span { font-size: 8px; font-weight: 800; color: var(--primary); display: block; margin-top: 4px; }

        .stat-card { 
            background: white; padding: 16px; border-radius: 20px; text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: 0.4s;
            border: 1px solid rgba(0,0,0,0.03);
        }
        .stat-card.dark-card { background: var(--dark); color: white; }
        
        .label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; opacity: 0.6; }
        .val { font-size: 1.1rem; font-weight: 900; display: block; margin-top: 6px; }
        .sub-profit { font-size: 0.7rem; color: var(--success); font-weight: 600; margin-top: 8px; display: block; }
        
        .container { max-width: 1000px; margin: auto; padding: 0 20px; }
        
        .btn-mob { 
            background: var(--dark); color: var(--accent); border: 2px solid var(--accent);
            padding: 10px; border-radius: 12px; font-weight: 800; cursor: pointer;
            width: 100%; margin-top: 8px; transition: 0.3s;
        }

        .btn-reset-day {
            background: #fff; color: var(--danger); border: 1.5px solid #ffe4e6;
            padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer;
            transition: 0.3s; margin-top: 20px; width: 100%;
        }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 20px; border-radius: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .entry-row { display: grid; grid-template-columns: 25px 1fr; gap: 10px; align-items: center; margin-bottom: 8px; }
        input { 
            width: 90%; padding: 10px; border: 1.5px solid #f1f5f9; border-radius: 10px; 
            font-weight: 700; background: #f8fafc; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); background: white; outline: none; }

        .nav-group { display: flex; gap: 8px; margin: 15px 0; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .btn-nav { padding: 10px 20px; border-radius: 12px; border: none; background: white; font-weight: 700; cursor: pointer; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-nav.active { background: var(--dark); color: white; transform: scale(1.05); }

        #mobUI { 
            display: none; position: fixed; inset: 0; background: var(--bg); z-index: 2000; 
            overflow-y: auto; animation: slideUp 0.4s ease-out;
        }
        .mob-top { background: var(--dark); color: white; padding: 30px 20px; text-align: center; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-wrap">
        <div class="dashboard-grid">
            <div class="stat-card reveal">
                <span class="label">Gross Deposits</span>
                <span class="val" id="resDep">0</span>
                <span class="sub-profit">8% Profit: <span id="p8Val">0</span></span>
            </div>
            <div class="stat-card reveal" style="animation-delay: 0.1s">
                <span class="label">Gross Withdraws</span>
                <span class="val" id="resWith">0</span>
                <button class="btn-mob" onclick="toggleMob(true)">‚ö° RECOVERY LOG</button>
            </div>
            <div class="stat-card dark-card reveal" style="animation-delay: 0.2s">
                <span class="label" style="opacity: 0.5">Front Loss</span>
                <span id="lossAmt" class="val" style="color:var(--danger)">0</span>
            </div>
        </div>

        <div class="qr-card reveal" style="animation-delay: 0.3s">
            <div id="qrcode"></div>
            <span>SCAN TO SYNC</span>
        </div>
    </div>
</div>

<div class="container reveal" style="animation-delay: 0.4s">
    <div id="weekNav" class="nav-group"></div>
    <div id="dayNav" class="nav-group"></div>

    <div class="main-grid">
        <div class="card"><h3>Deposits</h3><div id="depList"></div></div>
        <div class="card"><h3>Withdrawals</h3><div id="withList"></div></div>
    </div>

    <button class="btn-reset-day" onclick="resetCurrentDay()">üóëÔ∏è Clear Week <span id="resetW">1</span> - Day <span id="resetD">1</span> Only</button>
    <div style="height: 40px;"></div>
</div>

<div id="mobUI">
    <div class="mob-top">
        <h1 style="margin:0; font-size: 1.5rem;">MobCash Recovery Log</h1>
        <p id="logTitle" style="opacity: 0.7;">Week 1 - Day 1</p>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
            <button onclick="toggleMob(false)" style="padding:10px 25px; border-radius:12px; border:none; font-weight:800; cursor:pointer; background:white;">CLOSE</button>
            <button onclick="downloadPDF('Recovery')" style="padding:10px 25px; border-radius:12px; border:none; font-weight:800; cursor:pointer; background:var(--accent); color:var(--dark);">PDF LOG</button>
        </div>
    </div>
    <div class="container" style="margin-top:-20px">
        <div class="dashboard-grid">
            <div class="stat-card">
                <span class="label">Front Loss</span>
                <span id="mobFrontLoss" class="val" style="color:var(--danger)">0</span>
            </div>
            <div class="stat-card" style="border:1.5px solid var(--primary)">
                <span class="label">Total Comm.</span>
                <span id="combinedComm" class="val" style="color:var(--primary)">0</span>
            </div>
            <div class="stat-card">
                <span class="label">Remaining</span>
                <span id="finalRecovery" class="val">0</span>
            </div>
        </div>
        <div class="main-grid" style="padding-bottom:100px;">
            <div class="card"><h3>Recovery Dep (8%)</h3><div id="recDepList"></div></div>
            <div class="card"><h3>Recovery With (2%)</h3><div id="recWithList"></div></div>
        </div>
    </div>
</div>

<script>
    // 1. DATABASE CONFIG
    const firebaseConfig = { databaseURL: "https://pkr-quantum-sync-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);

    // 2. SESSION HANDLER
    let urlParams = new URLSearchParams(window.location.search);
    let sessionID = urlParams.get('pkr_session') || "ROOM_" + Math.floor(1000 + Math.random() * 9000);
    if(!urlParams.get('pkr_session')) window.history.replaceState({}, '', '?pkr_session=' + sessionID);
    const db = firebase.database().ref('sessions/' + sessionID);

    let cW = 1, cD = 1;
    let store = {};
    let isLocked = false;

    function init() {
        // Build Navigation
        const wn = document.getElementById('weekNav'), dn = document.getElementById('dayNav');
        for(let i=1; i<=4; i++) wn.innerHTML += `<button class="btn-nav" id="wn-${i}" onclick="setW(${i})">W${i}</button>`;
        for(let i=1; i<=7; i++) dn.innerHTML += `<button class="btn-nav" id="dn-${i}" onclick="setD(${i})">Day ${i}</button>`;
        
        // Build Rows
        const dl = document.getElementById('depList'), wl = document.getElementById('withList');
        const rdl = document.getElementById('recDepList'), rwl = document.getElementById('recWithList');
        for(let i=1; i<=20; i++) {
            dl.innerHTML += `<div class="entry-row"><span>${i}</span><input type="number" id="d${i}" oninput="pushToCloud()"></div>`;
            wl.innerHTML += `<div class="entry-row"><span>${i}</span><input type="number" id="w${i}" oninput="pushToCloud()"></div>`;
            rdl.innerHTML += `<div class="entry-row"><span>${i}</span><input type="number" id="rd${i}" oninput="pushToCloud()"></div>`;
            rwl.innerHTML += `<div class="entry-row"><span>${i}</span><input type="number" id="rw${i}" oninput="pushToCloud()"></div>`;
        }

        // Generate QR
        new QRCode(document.getElementById("qrcode"), { text: window.location.href, width: 70, height: 70 });

        // Listen for Global Changes
        db.on('value', (snap) => {
            isLocked = true; // Prevent loop
            store = snap.val() || {};
            updateUI();
            isLocked = false;
        });
    }

    function pushToCloud() {
        if(isLocked) return;
        let d=[], w=[], rd=[], rw=[];
        for(let i=1; i<=20; i++){
            d.push(document.getElementById(`d${i}`).value); 
            w.push(document.getElementById(`w${i}`).value);
            rd.push(document.getElementById(`rd${i}`).value); 
            rw.push(document.getElementById(`rw${i}`).value);
        }
        store[`w${cW}d${cD}`] = { d, w, rd, rw };
        db.set(store);
        calc();
    }

    function updateUI() {
        document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active'));
        document.getElementById(`wn-${cW}`)?.classList.add('active');
        document.getElementById(`dn-${cD}`)?.classList.add('active');
        document.getElementById('resetW').innerText = cW;
        document.getElementById('resetD').innerText = cD;

        const data = store[`w${cW}d${cD}`] || { d: [], w: [], rd: [], rw: [] };
        for(let i=1; i<=20; i++) {
            const fields = [`d${i}`, `w${i}`, `rd${i}`, `rw${i}`];
            const values = [data.d?.[i-1], data.w?.[i-1], data.rd?.[i-1], data.rw?.[i-1]];
            fields.forEach((id, index) => {
                const el = document.getElementById(id);
                if(document.activeElement !== el) el.value = values[index] || '';
            });
        }
        calc();
    }

    function calc() {
        let tD = 0, tW = 0, rD = 0, rW = 0;
        for(let i=1; i<=20; i++) {
            tD += parseFloat(document.getElementById(`d${i}`).value || 0);
            tW += parseFloat(document.getElementById(`w${i}`).value || 0);
            rD += parseFloat(document.getElementById(`rd${i}`).value || 0);
            rW += parseFloat(document.getElementById(`rw${i}`).value || 0);
        }
        let fl = tD - tW;
        let comm = (rD * 0.08) + (rW * 0.02);
        
        document.getElementById('resDep').innerText = "PKR " + tD.toLocaleString();
        document.getElementById('resWith').innerText = "PKR " + tW.toLocaleString();
        document.getElementById('p8Val').innerText = (tD * 0.08).toLocaleString();
        document.getElementById('lossAmt').innerText = "PKR " + Math.abs(fl).toLocaleString();
        
        document.getElementById('mobFrontLoss').innerText = "PKR " + Math.abs(fl).toLocaleString();
        document.getElementById('combinedComm').innerText = "PKR " + comm.toLocaleString();
        const fRec = document.getElementById('finalRecovery');
        let rem = Math.abs(fl) - comm;
        fRec.innerText = "PKR " + rem.toLocaleString();
        fRec.style.color = rem <= 0 ? "var(--success)" : "var(--danger)";
    }

    function setW(n) { cW = n; updateUI(); }
    function setD(n) { cD = n; updateUI(); }
    function toggleMob(s) { 
        document.getElementById('mobUI').style.display = s ? 'block' : 'none'; 
        if(s) { document.getElementById('logTitle').innerText = `Week ${cW} - Day ${cD}`; }
    }
    
    function resetCurrentDay() {
        if(confirm("Delete data for W" + cW + " D" + cD + "?")) {
            store[`w${cW}d${cD}`] = { d: [], w: [], rd: [], rw: [] };
            db.set(store);
        }
    }

    init();
</script>
</body>
</html>